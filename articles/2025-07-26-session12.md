---
title: "SessionÂ 12 â€” Prompt Flow ã§ LLMâ†’Python ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹"
emoji: "ğŸš¦"
type: "tech"
topics: ["promptflow","azure-openai","python","powershell","genai40days"]
published: True
---

> **GenAIÂ 40â€¯Days** ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª â€” *SessionÂ 12*

---

## TL;DR

- PromptÂ FlowÂ CLIÂ v1.18 ã§ **`pf flow init` + YAML ãƒ™ãƒ¼ã‚¹æ¥ç¶š** ã‚’æ¡ç”¨  
- AzureÂ OpenAI ã‚’ **`aoai-mini` æ¥ç¶š**ã¨ã—ã¦ç™»éŒ²ï¼ˆ`api_base` ã¯ `https://â€¦` å¿…é ˆï¼‰  
- **LLM ãƒãƒ¼ãƒ‰ â†’ Python ãƒãƒ¼ãƒ‰** ã¸ã¤ãªãã€æ”¹è¡Œã‚’é™¤å»ã™ã‚‹å¾Œå‡¦ç†ã‚’å®Ÿè£…  
- `pf flow test` ã¯ **--stream ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä¸è¦**ã€æˆåŠŸãƒ­ã‚°ã‚’ã‚¹ã‚¯ã‚·ãƒ§ ğŸ“¸  
- 5 ãƒªã‚¯ã‚¨ã‚¹ãƒˆè©¦ç®—ã§ **â‰ˆÂ Â¥4**ã€ç´¯è¨ˆ Â¥??Â /Â Â¥3,500 ä»¥å†…

* * *

## PromptÂ Flow ã¨ã¯ï¼Ÿ

PromptÂ Flow ã¯ **AzureÂ AIÂ Studio** ãŒæä¾›ã™ã‚‹ LLM ã‚¢ãƒ—ãƒªé–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªç‰¹å¾´ã‚’æŒã¡ã¾ã™ã€‚

| æ©Ÿèƒ½ | æ¦‚è¦ |
|------|------|
| **ãƒãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ** | LLM å‘¼ã³å‡ºã—ãƒ»Pythonãƒ»å¤–éƒ¨ API ãªã©ã‚’ *DAG* ã§æ¥ç¶šã—ã€ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã‚’è¦–è¦šåŒ–ã§ãã¾ã™ã€‚ |
| **CLI / SDK / VSÂ Code æ‹¡å¼µ** | `pf` ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œãƒ»ãƒ†ã‚¹ãƒˆãƒ»ãƒˆãƒ¬ãƒ¼ã‚¹ãŒå¯èƒ½ã€‚GUI ãŒä¸è¦ãª CI ç’°å¢ƒã§ã‚‚å†ç¾ã§ãã¾ã™ã€‚ |
| **å†ç¾æ€§ã®æ‹…ä¿** | ãƒãƒ¼ãƒ‰å®šç¾©ï¼ˆ`flow.dag.yaml`ï¼‰ã¨æ¥ç¶šå®šç¾©ï¼ˆ`*.yaml`ï¼‰ã‚’ Git ç®¡ç†ã™ã‚Œã°ã€ç’°å¢ƒå·®åˆ†ãªããƒ•ãƒ­ãƒ¼ã‚’å†æ§‹ç¯‰å¯èƒ½ã€‚ |
| **è©•ä¾¡ (Eval) æ©Ÿèƒ½** | ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯é¡ä¼¼åº¦ãƒ»ãƒ«ãƒ¼ãƒ–ãƒªãƒƒã‚¯è©•ä¾¡ãƒ»ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚»ãƒƒãƒˆæ¤œè¨¼ã‚’æ¨™æº–ã‚µãƒãƒ¼ãƒˆã€‚ |
| **Azure ãƒã‚¤ãƒ†ã‚£ãƒ–** | AzureÂ OpenAI / OpenAIÂ API ã®ä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€æ©Ÿå¯†æƒ…å ±ã‚’ KeyÂ Vault & CIÂ Secrets ã§å®‰å…¨ã«æ‰±ãˆã¾ã™ã€‚ |

> **Why PromptÂ Flow? â€” æ¡ç”¨ã—ãŸ 5 ã¤ã®ç†ç”±**
> - **ãƒãƒ¼ãƒ‰åˆ†é›¢ã§ãƒ†ã‚¹ãƒˆãŒãƒ©ã‚¯** â€” Prompt ã¨å¾Œå‡¦ç†ã‚’åˆ¥ãƒãƒ¼ãƒ‰ã«ã—ã€A/B ãƒ†ã‚¹ãƒˆã‚„éƒ¨åˆ†ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã‚’å®‰å…¨ã«å®Ÿè¡Œã§ãã‚‹ã€‚
> - **YAML + CLI ãŒ CI/CD å‘ã** â€” ã™ã¹ã¦ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†ãªã®ã§ GitHubÂ Actions ç­‰ã«ãã®ã¾ã¾è¼‰ã›ã‚‰ã‚Œã‚‹ã€‚
> - **Eval æ©Ÿèƒ½ãŒçµ„ã¿è¾¼ã¿** â€” å“è³ªæŒ‡æ¨™ã‚’è‡ªå‹•è¨ˆæ¸¬ã—ã€æ”¹ä¿®ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã‚’æ•°å€¤åŒ–ã—ã‚„ã™ã„ã€‚
> - **Azure ãƒªã‚½ãƒ¼ã‚¹ã¨è¦ªå’Œæ€§â—** â€” KeyÂ Vault ã‚„ ManagedÂ Identity ã¨çµ±åˆã§ãã€ãƒ­ãƒ¼ã‚«ãƒ«â†”ã‚¯ãƒ©ã‚¦ãƒ‰ã§è¨­å®šã‚’å…±é€šåŒ–ã€‚
> - **GUI & VSÂ Code æ‹¡å¼µã§å­¦ç¿’ã‚³ã‚¹ãƒˆä½** â€” DAG ã‚’è¦–è¦šã§ç†è§£ã§ãã€ãƒãƒ¼ãƒ å…±æœ‰ãŒç°¡å˜ã€‚

* * *

## 1. ã‚´ãƒ¼ãƒ«

é …ç›® | å†…å®¹  
---|---  
Session | 12  
ä¸»é¡Œ | PromptÂ Flow ã§ LLMï¼‹Python ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³  
æˆæœç‰© | `sessions/s12/flow/*`  
æƒ³å®šã‚³ã‚¹ãƒˆ | â‰ˆÂ Â¥4  

* * *

## 2. äº‹å‰æº–å‚™ (10Â min)

### 2â€‘1. venv & ä¾å­˜
```powershell
python -m venv .venv
. .venv\Scripts\Activate.ps1
pip install --upgrade promptflow promptflow-tools openai python-dotenv
```

### 2â€‘2. `.env`
```dotenv
AZURE_OPENAI_ENDPOINT=https://<resource>.openai.azure.com/
AZURE_OPENAI_API_KEY=<your key>
AZURE_OPENAI_DEPLOYMENT=mini
```

* * *

## 3. Flow é››å½¢ç”Ÿæˆ (5Â min)
```powershell
mkdir sessions\s12
cd sessions\s12
pf flow init --flow flow --type chat
```
ç”Ÿæˆã•ã‚ŒãŸ `flow/` ã«ã¯ `prompt.jinja2`, `flow.dag.yaml` ãªã©ãŒå…¥ã‚Šã¾ã™ã€‚

* * *

## 4. AzureÂ OpenAI æ¥ç¶š (10Â min)

`connections/aoai-mini.yaml`
```yaml
$schema: https://azuremlschemas.azureedge.net/promptflow/latest/AzureOpenAIConnection.schema.json
name: aoai-mini
type: azure_open_ai
api_base: ${env:AZURE_OPENAI_ENDPOINT}
api_version: 2024-05-01-preview
api_key: ${env:AZURE_OPENAI_API_KEY}
```

```powershell
mkdir connections
Copy-Item .\flow\azure_openai.yaml .\connections\aoai-mini.yaml
pf connection create -f connections/aoai-mini.yaml -n aoai-mini --yes
```

* * *

## 5. Python å¾Œå‡¦ç†ãƒãƒ¼ãƒ‰ (3Â min)

`flow/nodes/post.py`
```python
def format_answer(response: str) -> str:
    """ä½™åˆ†ãªæ”¹è¡Œã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«ç•³ã‚€"""
    return response.strip().replace("\n", " ")
```

* * *

## 6. DAG ã‚’æ¥ç¶š (5Â min)

`flow.dag.yaml` æŠœç²‹:
```yaml
- id: chat
  type: chat_completion
  connection: aoai-mini
  inputs:
    deployment_name: mini  # Azure Portal ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤å
    question: ${inputs.question}

- id: format
  type: python
  source: nodes/post.py
  inputs:
    response: ${chat.output}
```

* * *

## 7. ãƒ†ã‚¹ãƒˆ & çµæœ (5Â min)
```powershell
pf flow test --flow flow --inputs question="Prompt Flow ã¨ã¯ï¼Ÿ"
```
![ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ](/images/s12-flow-test.png)

* * *

## 8. GitHub main ã¸å…¬é–‹ (2Â min)
```powershell
cd ../..
git add sessions/s12
git commit -m "feat: session12 prompt flow"
git push -u origin session/12-prompt-flow
```
PullÂ Request â†’ RebaseÂ &Â Merge ã§ `main` ã¸åæ˜ ã—ã¾ã™ã€‚

* * *

## 9. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒˆ

ç—‡çŠ¶ | åŸå›  | è§£æ±º  
---|---|---  
`UnsupportedProtocol` | `https://` ãŒæŠœã‘ãŸ | `.env` ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä¿®æ­£  
`EmptyLLMApiMapping` | `promptflow-tools` æœªå°å…¥ | `pip install -U promptflow-tools`  
`401 Invalid subscription key` | ã‚­ãƒ¼ / ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ / ãƒ‡ãƒ—ãƒ­ã‚¤åä¸ä¸€è‡´ | Portal ã‹ã‚‰å€¤ã‚’å†ã‚³ãƒ”ãƒ¼ â†’ `pf connection update`  

* * *

## 10. å­¦ã³ãƒã‚¤ãƒ³ãƒˆ

- æœ€æ–° CLI ã§ã¯ **YAML ã§æ¥ç¶šå®šç¾©** â†’ `pf connection create -f ...` æ–¹å¼ã«ä¸€æœ¬åŒ–  
- `deployment_name` ã¯ Azure ç‹¬è‡ªæ¦‚å¿µã€‚**ãƒ¢ãƒ‡ãƒ«åã§ã¯ãªããƒ‡ãƒ—ãƒ­ã‚¤å**ã‚’æŒ‡å®š  
- Python ãƒãƒ¼ãƒ‰ã§ã¡ã‚‡ã£ã¨ã—ãŸæ•´å½¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†ã‚’ã‚³ãƒ¼ãƒ‰åŒ–ã§ãã‚‹

* * *

## 11. æ¬¡å›äºˆå‘Š

SessionÂ 13 ã§ã¯ PromptÂ Flow ã® **Eval** ã§ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯é¡ä¼¼åº¦ã‚’æ¸¬å®šã—ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ”¹å–„ã‚µã‚¤ã‚¯ãƒ«ã‚’å›ã—ã¾ã™ã€‚ğŸš€

---

### ãƒªãƒ³ã‚¯é›†
- PromptÂ Flow CLI ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ <https://learn.microsoft.com/azure/ai-studio/prompt-flow/cli>
- GenAIÂ 40Â Days GitHub <https://github.com/yourname/genai-40days>

